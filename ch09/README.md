# ch09 - 指针

## jalr 用于函数指针

`jalr`（Jump And Link Register）是 RISC-V 汇编语言中的一条指令，用于实现寄存器间接跳转。这条指令不仅让程序跳转到一个新的地址执行代码，而且还能保存跳转前的下一条指令的地址，从而支持之后返回到跳转前的位置。`jalr` 指令在函数调用和返回时特别有用。

### `jalr` 指令格式

`jalr` 的基本格式是这样的：

```
jalr rd, rs1, offset
```

- `rd` 是目标寄存器，用于保存跳转前的下一条指令的地址（返回地址）。通常在函数调用时，这个寄存器是 `ra`（寄存器编号 x1），即 "return address" 寄存器。
- `rs1` 是基址寄存器，包含目标地址的基本部分。跳转的目的地址是从这个寄存器的值和立即数 `offset` 相加得到的。
- `offset` 是一个立即数偏移量，和 `rs1` 寄存器的值相加，计算最终的跳转地址。通常这个偏移量是 0，因为目标地址直接存储在 `rs1` 中。

### 如何工作

当执行 `jalr` 指令时，CPU 会做两件事：

1. 将当前指令的下一条指令的地址（即跳转前的 PC（程序计数器）值加 4）保存到 `rd` 寄存器（rd 表示 register dest）。
   这样做是为了在完成跳转的代码执行后，能够通过这个地址返回到原来的代码序列中继续执行。
2. 计算跳转地址（`rs1 + offset`），并将程序计数器（PC）设置为这个地址，从而跳转到目标地址执行代码。

### 使用场景

- **函数调用**：当调用一个函数时，可以使用 `jalr` 指令跳转到函数的起始地址，并将返回地址保存在 `ra` 寄存器中。
  这样，函数执行完毕后，可以通过 `jalr ra` 指令跳回到调用处继续执行。
- **函数返回**：函数通常使用 `jalr ra` 指令返回到调用者。这时，`ra` 寄存器中保存的是调用这个函数的指令后的下一条指令的地址。

### 示例

调用一个函数：

```assembly
# 假设函数地址在寄存器a1中
jalr ra, a1, 0  # 跳转到a1指向的函数，保存返回地址到ra寄存器
```

函数返回：

```assembly
jalr zero, ra, 0  # 使用ra中的地址返回到调用者，zero寄存器（x0）被用作占位符
```

`jalr` 指令是实现函数调用和返回机制的核心，使得 RISC-V 程序能够组织成模块化和可重用的代码块。

`jalr` 指令是 RISC-V 指令集中的一条跳转指令，全称为 "Jump And Link Register"。
这条指令执行两个主要操作：首先，它将当前指令的下一条指令的地址（即返回地址）保存到 `ra`（返回地址寄存器）或指定的目标寄存器中；
然后，它通过寄存器指定的地址进行跳转执行。这种机制常用于函数调用和返回，其中跳转地址不是固定的，
而是存储在寄存器中，例如函数指针的调用场景。

### `jalr` 指令格式

RISC-V 中 `jalr` 指令的一般格式如下：

```
jalr rd, rs1, offset
```

- `rd` 是目标寄存器，用于存储返回地址（即跳转发生后应继续执行的下一条指令的地址）。如果省略或为零，则不保存返回地址。
- `rs1` 是基址寄存器，包含跳转目标地址。
- `offset` 是一个立即数偏移量，将加到 `rs1` 寄存器的值上以形成最终的跳转地址。如果省略，偏移量默认为 0。

### 为什么只有 `a2`

在你提到的 `jalr a2` 使用场景中，指令形式实际上是一个简化的形式，它隐含了一些默认的操作和参数：

- 当 `jalr` 指令后只跟一个寄存器（如 `a2`）时，按照 RISC-V 的默认调用约定，
  这意味着执行跳转到 `a2` 寄存器所指向的地址，同时将返回地址保存到 `ra` 寄存器中。
  这里省略了目标寄存器（`rd`）和偏移量（`offset`），因为在很多函数调用场景中，
  默认的目标寄存器是 `ra`，且偏移量为 0。
- `jalr` 指令通常用在函数调用的场景中，特别是调用函数指针时。
  在这种情况下，函数的地址在运行时才确定，存储在一个寄存器（如此例中的 `a2`）中。
  执行 `jalr a2` 就会跳转到 `a2` 所指向的地址执行，并假定跳转目标是一个函数入口，
  函数执行完毕后通过 `ra` 寄存器中的返回地址返回。

总结，`jalr a2` 这种简化形式的指令用于通过 `a2` 寄存器指定的地址进行函数调用，
同时自动将返回地址保存在 `ra` 寄存器中，以便函数执行完后可以返回到调用点继续执行。
这是 RISC-V 中实现函数指针调用的一种典型方式。

jalr a2 是调用函数指针，遵循函数调用惯例
